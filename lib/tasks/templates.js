module.exports = function(gulp, config) {
	var errorHandler = require('../helpers/error_handler')()
	var resolveData = require('../helpers/resolveData')

	return function(done) {
		if(!config.templates) return done()
		var c = require('better-console')
		c.info('~ templates')

		var _ = require('lodash')
		var s_ = require('stream')
		var cache = require('gulp-cached')
		var data = require('gulp-data')
		var frontMatter = require('gulp-front-matter')
		var gulpFilter = require('gulp-filter')
		var gulpif = require('gulp-if')
		var pug = require('pug')
		var gulpPug = require('gulp-pug')
		var jf = require('jsonfile')
		var path = require('path')
		var plumber = require('gulp-plumber')
		var merge = require('merge-stream')

		var filterPug = gulpFilter('**/*.{jade,pug}', { restore: true })
		var filterStatic = gulpFilter('**/*.{html,htm}', { restore: true })

		var sourceGlob = []
		var templatesData = {}
		var masterTemplates = []

		for (var i = 0; i < config.templates.length; i++) {
			var template = config.templates[i]
			// Master templates
			if(typeof template == 'object' && typeof template.template == 'string') {
				masterTemplates.push(template)
			// Single templates
			} else if (typeof template == "string") {
				sourceGlob.push(template)
			} else {
				c.error('Templates: Unrecognised type of input')
			}
		}

		// Try to read data from external JSON files or pass inline object
		if(config.data) {
			for(var key in config.data){
				var value = config.data[key]
				var resolve = resolveData(value, config)
				if(resolve !== null) {
					value = resolve
				}
				templatesData[key] = value
			}
		}
		templatesData.require = require
		templatesData.devmode = config.devmode
		templatesData.production = !config.devmode
		templatesData.buildstamp = (config.buildstamp && !config.devmode) ? config.stamp : ''

		// Default Jade options
		var pugOptions = {
			pug: pug,
			pretty: true,
			cache: true,
			compileDebug: true,
			doctype: 'html',
			basedir: config.dir
		}
		if(config.pug) {
			_.assign(pugOptions, config.pug)
		}

		var source = merge()
		var sourceOpts = {
			// base: config.src_folder, <-- this causes templates not to be in the root folder
			cwd: config.dir,
		}

		// Pipe all normal templates
		source.add(gulp.src(sourceGlob, sourceOpts))

		// Pipe templates, which has to be multiplied
		_.each(masterTemplates, template => {
			var transformFnc = function() {
				var stream = new s_.Transform({ objectMode: true })

				stream._transform = (file, enc, callback) => {
					file.templateData = template.data
					callback(null, file)
				}
				return stream
			}

			source.add(gulp.src(template.template, sourceOpts).pipe(transformFnc()))
		})

		// Init plumber in devmode
		var task = source
		if(config.devmode){
			task = task.pipe(plumber({ errorHandler: errorHandler.fail }))
		}

		task = task.pipe(frontMatter({
				property: 'frontMatter',
				remove: true
			}))
			// Add data to files which needs that
			.pipe(filterPug)
			.pipe(function () {
				var transformStream = new s_.Transform({ objectMode: true });
				transformStream._transform = function (file, encoding, callback) {
					if(file.templateData) {
						var filesData = resolveData(file.templateData, config)
						for (var index in filesData) {
							var fileClone = file.clone()
							var fileData = filesData[index]
							fileClone.path = path.join(fileClone.base, index)
							fileClone.data = { fileData: fileData, filePath: fileClone.path }
							this.push(fileClone)
						}
						callback()
						return
					}
					callback(null, file)
				}
				return transformStream
			}())
			.pipe(data(function(file) {
				var name = path.basename(file.path)
				var data = _.cloneDeep(templatesData)

				// In case of name == key, assign value as global object
				if(typeof templatesData[name] !== 'undefined') {
					var obj = _.assign(data, templatesData[name], file.data)
					return obj
				} else {
					var obj = _.assign(data, file.data)
					return obj
				}
			}))
			.pipe(gulpPug(pugOptions))
			.pipe(filterPug.restore)
			.pipe(cache('templates', { optimizeMemory: true }))

		if(config.devmode){
			task.on('end', function() {
				errorHandler.done()
			})
		}

		return task.pipe(gulp.dest(config.dist_folder))
	}
}
